<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bc.pmpheep.back.dao.WriterRoleDao">

	<insert id="add" parameterType="WriterRole">
        INSERT INTO writer_role
        (
        	`role_name`,
        	is_disabled,
        	note,
        	sort,
        	gmt_create,
        	gmt_update
        )
        VALUES
         (
         	#{roleName,jdbcType=VARCHAR},
        	#{isDisabled,jdbcType=TINYINT},
        	#{note,jdbcType=VARCHAR},
        	#{sort,jdbcType=Integer},
        	#{gmtCreate,jdbcType=TIMESTAMP},
        	#{gmtUpdate,jdbcType=TIMESTAMP}
         )
    </insert>

    <delete id="delete" parameterType="int">
        DELETE FROM writer_role
        WHERE id = #{id}
    </delete>

    <delete id="batchDelete" parameterType="list">
        DELETE FROM writer_role
        WHERE id IN
        <foreach collection="ids" separator="," item="id" open="(" close=")">
            #{id}
        </foreach>
    </delete>

    <select id="get" parameterType="int" resultType="WriterRole">
        SELECT
           *
        FROM
            writer_role
        WHERE id = #{id}
    </select>

    <update id="update" parameterType="WriterRole">
        UPDATE
            writer_role
        <set>
        	<if test="roleName != null and roleName!=''">
                role_name = #{roleName},
            </if>
           <if test="isDisabled != null and isDisabled!=''">
                is_disabled = #{isDisabled},
            </if>
            <if test="note != null and note!=''">
                note = #{note},
            </if>
            <if test="sort != null and sort!=''">
                sort = #{sort},
            </if>
        </set>
    </update>

    <select id="getListRole" resultType="WriterRole">
        SELECT
            id,
            `role_name`
        FROM
            writer_role
    </select>

    <select id="getUserRole" resultType="WriterUserRole" parameterType="map">
        SELECT
            id,
            user_id,
            role_id
        FROM
            writer_user_role
        WHERE
            user_id = #{userId} AND role_id = #{roleId}
    </select>

    <insert id="addUserRole" parameterType="map">
        INSERT INTO `writer_user_role`(`user_id`,`role_id`)
        VALUES(#{userId},#{roleId})
    </insert>

    <!-- 批量添加用户角色关联表数据 -->
    <insert id="addUserRoles" parameterType="map">
        INSERT INTO `writer_user_role`(`user_id`,`role_id`)
        VALUES
        <foreach collection="roleIds" item="role_id" separator=",">
            (#{userId},#{role_id})
        </foreach>
    </insert>

    <delete id="deleteUserRole" parameterType="map">
        DELETE FROM writer_user_role
        WHERE
            user_id = #{userId} AND role_id = #{roleId}
    </delete>

    <!-- 删除这个用户所有的角色 -->
    <delete id="deleteUserRoles">
        DELETE FROM writer_user_role
        WHERE
            user_id = #{userId}
    </delete>

    <!-- 根据角色 id 查询该角色 id 下的所有资源 -->
    <select id="getListRoleResource" parameterType="int" resultType="WriterPermission">
        SELECT
            tr.`id`,
            tr.`parent_id`,
            tr.`path`,
            tr.`permission_name`,
            tr.`menu_name`,
            tr.`url`
        FROM `writer_permission` tr
        LEFT JOIN `writer_role_permission` trr ON tr.`id` = trr.`permission_id`
        WHERE trr.`role_id` = #{roleId}
    </select>

    <insert id="addRoleResource" parameterType="map">
        INSERT INTO writer_role_permission(role_id,permission_id)
        VALUES(#{roleId},#{permissionId})
    </insert>

    <delete id="deleteRoleResource" parameterType="map">
        DELETE FROM writer_role_permission
        WHERE
            role_id = #{roleId} AND permission_id = #{permissionId}
    </delete>

    <select id="getResourceRole" parameterType="map" resultType="RoleResource">
        SELECT
            id,
            role_id,
            permission_id
        FROM
            writer_role_permission
        WHERE
            role_id = #{roleId} AND resource_id = #{resourceId}
    </select>

    <delete id="batchDeleteRoleResource" parameterType="list">
        DELETE FROM writer_role_permission
        WHERE role_id IN
        <foreach collection="roleIds" item="roleId" open="(" separator="," close=")">
            #{roleId}
        </foreach>
    </delete>

    <delete id="deleteRoleAndUser" parameterType="list">
        DELETE FROM writer_user_role
        WHERE role_id in
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

</mapper>