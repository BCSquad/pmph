<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.bc.pmpheep.back.dao.OrgDao">

	<sql id="key">
		<!-- 去掉最后一个, -->
		<trim suffixOverrides=",">
			<if test="id !=null ">
				id,
			</if>
			<if test="parentId != null and parentId !=''">
				parent_id,
			</if>
			<if test="orgName != null and orgName !=''">
				org_name,
			</if>
			<if test="orgTypeId != null and orgTypeId !=''">
				org_type_id,
			</if>
			<if test="areaId != null and areaId !=''">
				area_id,
			</if>
			<if test="countactPerson != null and countactPerson !=''">
				contact_person,
			</if>
			<if test="countactPhone != null and countactPhone !=''">
				contact_phone,
			</if>
			<if test="note != null and note !=''">
				note,
			</if>
			<if test="sort != null and sort !=''">
				sort,
			</if>
			<if test="isDeleted != null">
				is_deleted,
			</if>
		</trim>
	</sql>
	<!-- sql片段对应?,id属性值任意 -->
	<sql id="value">
		<!-- 去掉最后一个, -->
		<trim suffixOverrides=",">
			<if test="id !=null ">
				#{id},
			</if>
			<if test="parentId !=null and parentId !=''">
				#{parentId},
			</if>
			<if test="orgName !=null and orgName !=''">
				#{orgName},
			</if>
			<if test="orgTypeId !=null and orgTypeId !=''">
				#{orgTypeId},
			</if>
			<if test="areaId !=null and areaId !=''">
				#{areaId},
			</if>
			<if test="countactPerson !=null and countactPerson !=''">
				#{countactPerson},
			</if>
			<if test="countactPhone !=null and countactPhone !=''">
				#{countactPhone},
			</if>
			<if test="note !=null and note !=''">
				#{note},
			</if>
			<if test="sort !=null and sort !=''">
				#{sort},
			</if>
			<if test="isDeleted !=null">
				#{isDeleted},
			</if>
		</trim>
	</sql>

	<!-- 新增Org -->
	<insert id="addOrg" parameterType="Org">
		<selectKey resultType="java.lang.Long" order="AFTER"
			keyProperty="id"> <!-- order="AFTER"表示先执行插入语句，之后再执行查询语句 BEFORE 或 AFTER -->
			SELECT LAST_INSERT_ID()
		</selectKey>
		insert into org (
		<include refid="key" />
		)
		values(
		<include refid="value" />
		) ;
	</insert>

	<!-- 根据id查询一个Org -->
	<select id="getOrgById" parameterType="java.lang.Long"
		resultType="Org">
		select * from org where id=#{id} ;
	</select>

	<!--orgNmae模糊查询获取列表 -->
	<select id="getOrgList" parameterType="PageParameter" resultType="OrgVO">
		select
		a.id,a.org_name,c.type_name,b.area_name,a.contact_person,a.contact_phone,a.sort,a.note,t.count
		from org a
		left join area b on a.area_id =b.id
		left join org_type c on
		a.org_type_id=c.id,
		(
		select count(*) count from org a
		left join area b
		on a.area_id =b.id
		left join org_type c on a.org_type_id=c.id
		where
		a.is_deleted = 0
		<if test="parameter !=null ">
			<if test="parameter.orgName !=null and  parameter.orgName != '' ">
				and a.org_name like
				concat(concat('%',#{parameter.orgName}),'%')
			</if>
			<if test="parameter.orgTypeId != null">
				and c.id = #{parameter.orgTypeId}
			</if>
			<if test="parameter.areaId != null">
				and b.id = #{parameter.areaId}
			</if>
		</if>
		)t
		where a.is_deleted = 0
		<if test="parameter !=null ">
			<if test="parameter.orgName !=null and  parameter.orgName != '' ">
				and a.org_name like
				concat(concat('%',#{parameter.orgName}),'%')
			</if>
			<if test="parameter.orgTypeId != null">
				and c.id = #{parameter.orgTypeId}
			</if>
			<if test="parameter.areaId != null">
				and b.id = #{parameter.areaId}
			</if>
		</if>
		order by a.sort
		<if test="start !=null and pageNumber != null">
			limit #{start},#{pageSize}
		</if>
	</select>
	
	<!-- 系统消息——发送新消息——发送对象（学校管理员、所有人） -->
	<select id="listSendToSchoolAdminOrAllUser" parameterType="map" resultType="OrgVO">
		SELECT 
			GROUP_CONCAT(o.`id`) id,
			GROUP_CONCAT(o.`org_name`)org_name,
			o.`area_id`,
			o.`parent_id`,
			GROUP_CONCAT(ot.`type_name`)type_name,
			ar.`area_name` 
		FROM 
			`org` o 
		LEFT JOIN 
			`org_type` ot 
		ON 
			o.`org_type_id` = ot.`id` 
		LEFT JOIN 
			`area` ar ON o.`area_id` = ar.`id` 
		WHERE 
			1=1
			<if test="orgName !=null and orgName != '' ">
				and o.`org_name` LIKE CONCAT(CONCAT('%',#{orgName},'%'))
			</if>
		GROUP BY 
			o.`area_id` 
		ORDER BY 
			o.`area_id`,o.`id` ASC;
	</select>
	
	<!-- 新增用户或者修改用户是加载的机构 -->
	<select id="listOrgByOrgName" parameterType="String"
		resultType="OrgVO">
		select id,org_name from org where org_name like #{orgName};
	</select>
	
	<!-- 查询表单的数据总数 -->
	<select id="getOrgCount" resultType="Long">
		select
		count(*)
		from
		org
	</select>

	<!-- 更新Org -->
	<update id="updateOrg" parameterType="Org">
		update org
		<set>
			<if test="parentId != null and parentId !=''">
				parent_id = #{parentId},
			</if>
			<if test="orgName != null and orgName !='' ">
				org_name = #{orgName},
			</if>
			<if test=" orgTypeId != null and orgTypeId !=''">
				org_type_id= #{orgTypeId},
			</if>
			<if test=" areaId != null and areaId !=''">
				area_id= #{areaId},
			</if>
			<if test=" countactPerson != null and countactPerson !=''">
				contact_person = #{countactPerson},
			</if>
			<if test="countactPhone != null and countactPhone !='' ">
				contact_phone = #{countactPhone},
			</if>
			<if test=" note != null and note !=''">
				note= #{note},
			</if>
			<if test=" sort != null and sort !=''">
				sort= #{sort},
			</if>
			<if test=" isDeleted != null ">
				is_deleted = #{isDeleted},
			</if>
		</set>
		where id=#{id} ;
	</update>
	
	<!-- 根据id删除一个Org -->
	<delete id="deleteOrgById" parameterType="java.lang.Long">
		delete from 
			org 
		where
			id=#{id} ;
	</delete>
</mapper>