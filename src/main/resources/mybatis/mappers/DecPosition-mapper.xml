<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.bc.pmpheep.back.dao.DecPositionDao">

	<sql id="key">
		<!-- 去掉最后一个, -->
		<trim suffixOverrides=",">
			<if test="id !=null">
				id,
			</if>
			<if test="declarationId !=null">
				declaration_id,
			</if>
			<if test="textbookId !=null">
				textbook_id,
			</if>
			<if test="presetPosition !=null ">
				preset_position,
			</if>
			<if test="isOnList !=null">
				is_on_list,
			</if>
			<if test="chosenPosition !=null">
				chosen_position,
			</if>
			<if test="rank !=null">
				rank,
			</if>
			<if test="syllabusId !=null and syllabusId !=''">
				syllabus_id,
			</if>
			<if test="syllabusName !=null and syllabusName !=''">
				syllabus_name,
			</if>
		</trim>
	</sql>
	<!-- sql片段对应?,id属性值任意 -->
	<sql id="value">
		<trim suffixOverrides=",">
			<if test="id !=null">
				#{id},
			</if>
			<if test="declarationId !=null">
				#{declarationId},
			</if>
			<if test="textbookId !=null">
				#{textbookId},
			</if>
			<if test="presetPosition !=null ">
				#{presetPosition},
			</if>
			<if test="isOnList !=null">
				#{isOnList},
			</if>
			<if test="chosenPosition !=null">
				#{chosenPosition},
			</if>
			<if test="rank !=null">
				#{rank},
			</if>
			<if test="syllabusId !=null and syllabusId !=''">
				#{syllabusId},
			</if>
			<if test="syllabusName !=null and syllabusName !=''">
				#{syllabusName},
			</if>
		</trim>
	</sql>

	<!-- 新增DecPosition -->
	<insert id="addDecPosition" parameterType="DecPosition">
		<selectKey resultType="java.lang.Long" order="AFTER"
			keyProperty="id"> <!-- order="AFTER"表示先执行插入语句，之后再执行查询语句 BEFORE 或AFTER -->
			SELECT LAST_INSERT_ID()
		</selectKey>
		insert into dec_position(
		<include refid="key" />
		)
		values(
		<include refid="value" />
		);
	</insert>

	<!-- 根据id删除一个作家申报职位信息 -->
	<delete id="deleteDecPosition" parameterType="java.lang.Long">
		delete from
		dec_position where
		id=#{id};
	</delete>

	<!-- 更新作家申报职位信息 -->
	<update id="updateDecPosition" parameterType="DecPosition">
		update dec_position
		<set>
			<if test="declarationId !=null">
				declaration_id = #{declarationId},
			</if>
			<if test="textbookId !=null">
				textbook_id = #{textbookId},
			</if>
			<if test="presetPosition !=null ">
				preset_position = #{presetPosition},
			</if>
			<if test="isOnList !=null">
				is_on_list = #{isOnList},
			</if>
			<if test="chosenPosition !=null">
				chosen_position = #{chosenPosition},
			</if>
			<if test="rank !=null">
				rank = #{rank},
			</if>
			<if test="syllabusId !=null and syllabusId !=''">
				syllabus_id = #{syllabusId},
			</if>
			<if test="syllabusName !=null and syllabusName !=''">
				syllabus_name = #{syllabusName},
			</if>
		</set>
		where id=#{id} ;
	</update>

	<!-- 根据id查询一个作家申报职位信息 -->
	<select id="getTextbookNameAndPresetPosition" parameterType="java.lang.Long"
		resultType="Map">
		SELECT
		GROUP_CONCAT(
		CONCAT(t.textbook_name)
		ORDER BY
		t.sort
		)
		textbookName,
		GROUP_CONCAT(
		CONCAT(
		t.textbook_name,
		'-',
		CASE
				when c.preset_position =15  then '主编,副主编,编委,数字编委'       <!-- 1111 -->
				when c.preset_position =14  then '主编,副主编,数字编委'          <!-- 1110 -->
				when c.preset_position =13  then '主编,编委,数字编委'            <!-- 1101 -->
				when c.preset_position =12  then '主编,数字编委'               <!-- 1100 -->
				when c.preset_position =11  then '副主编,编委,数字编委'          <!-- 1011 -->
				when c.preset_position =10  then '副主编,数字编委'              <!-- 1010 -->
				when c.preset_position =9   then '编委,数字编委'               <!-- 1001 -->
				when c.preset_position =8   then '数字编委'                   <!-- 1000 -->
				when c.preset_position =7   then '主编,副主编,编委'             <!-- 0111 -->
				when c.preset_position =6   then '主编,副主编'                 <!-- 0110 -->
				when c.preset_position =5   then '主编,编委'                  <!-- 0101 -->
				when c.preset_position =4   then '主编'                      <!-- 0100 -->
				when c.preset_position =3   then '副主编,编委'                 <!-- 0011 -->
				when c.preset_position =2   then '副主编'                     <!-- 0010 -->
				when c.preset_position =1   then '编委'                      <!-- 0001 -->
				else null
		END
		)
		ORDER BY
		t.sort
		) presetPosition
		FROM
		dec_position p
		LEFT JOIN textbook t ON t.id =
		p.textbook_id
		WHERE p.declaration_id =#{declarationId};
	</select>

	<!-- 根据id查询一个作家申报职位信息 -->
	<select id="getDecPositionById" parameterType="java.lang.Long"
		resultType="DecPosition">
		select * from dec_position where id=#{id};
	</select>

	<!-- 根据declarationId查询作家申报职位信息 -->
	<select id="listDecPositions" parameterType="java.lang.Long"
		resultType="DecPosition">
		select * from dec_position where
		declaration_id=#{declarationId};
	</select>
	
	<!-- 根据书籍ids查询申报职位列表 -->
	<select id="listDecPositionsByTextbookId" parameterType="java.lang.Long"
		resultType="DecPosition">
		select
		DISTINCT a.*
		from
		dec_position a
		left join
		declaration b
		on
		b.id =a.declaration_id
		LEFT JOIN
		textbook c
		on
		c.id=a.textbook_id
		where
		b.id is not null
		and b.is_staging =false
		and b.online_progress != 2
		and
		c.id = #{textbookId};
	</select>
	
	<!-- 根据书籍id查询申报职位列表 -->
	<select id="listDecPositionsByTextBookIds" resultType="DecPosition">
		select * from dec_position where textbook_id in 
		<foreach collection="textbookIds"  open="("  separator=","  close=")"  item="bookId"  index="index">
			#{bookId}
		</foreach>
	</select>

	<!-- 根据书籍id获取入选的职位职位(主编、副主编、编委、数字编辑) -->
	<select id="listChosenDecPositionsByTextbookId" parameterType="java.lang.Long"
		resultType="DecPosition">
		select DISTINCT a.* 
		from dec_position a 
		left join declaration b on b.id =a.declaration_id 
		LEFT JOIN textbook c on c.id=a.textbook_id 
		where 
		b.id is not null 
		and (a.chosen_position in (1,2,3,4,5,6,7,8,9,10,11,12,13,14,15)) 
		and b.is_staging =false 
		and b.online_progress > 0 
		and c.id = #{textbookId}
	</select>

	<!-- 根据书籍id查询申报id -->
	<select id="listDecPositionsByTextbookIds" resultType="java.lang.Long">
		SELECT
			d.`user_id`
		FROM
			declaration d
		LEFT JOIN
			dec_position p
		ON
			d.id = p.declaration_id
		WHERE
			p.textbook_id
		in
		<foreach collection="array" item="item" index="index" open="("
			close=")" separator=",">
			#{item}
		</foreach>
	</select>
	
	<!-- 根据书籍ID查询对应书籍申报人员信息 -->
	<select id="listDeclarationByTextbookIds" parameterType="PageParameter" resultType="TextBookDecPositionVO">
		SELECT
			d.`user_id`,
			d.`realname`,
  			o.`org_name`,
  			t.`count`
		FROM
			declaration d
		LEFT JOIN
			dec_position p
		ON
			d.id = p.declaration_id
		JOIN 
			`org` o
  		ON 
  			o.`id`=d.`org_id`,
  			(
  				SELECT 
  					COUNT(*) `count`
  				FROM
					declaration d
				LEFT JOIN
					dec_position p
				ON
					d.id = p.declaration_id
				JOIN 
					`org` o
		  		ON 
		  			o.`id`=d.`org_id`
		  		<where>
			  		<!-- 下面是动态条件 -->
					<if test="parameter !=null ">
						<!-- 问卷标题 -->
						<if test="parameter.textBookIds != null ">
							p.textbook_id in
							<foreach collection="parameter.textBookIds" item="item" index="index" open="(" close=")" separator=",">
								#{item}
							</foreach>
						</if>
					</if>
		  		</where>
		  			
  			)t
		<where>
			<!-- 下面是动态条件 -->
			<if test="parameter !=null ">
			<!-- 问卷标题 -->
				<if test="parameter.textBookIds != null ">
					p.textbook_id in
					<foreach collection="parameter.textBookIds" item="item" index="index" open="(" close=")" separator=",">
						#{item}
					</foreach>
				</if>
			</if>
		</where>
		ORDER BY o.`id` 
		<if test="start !=null and pageNumber != null">
			limit #{start},#{pageSize}
		</if>
	</select>

	<!-- 查询作家申报职位表的总记录数 -->
	<select id="getDecPosition" resultType="java.lang.Long">
		select count(*) from
		dec_position
	</select>

	<!-- 根据orgid和bookid获取该机构某些已公布的书的申报职位 -->
	<select id="listDecPositionsByTextbookIdAndOrgid" parameterType="java.util.Map"
		resultType="DecPosition">
		select DISTINCT a.*
		from dec_position a
		LEFT JOIN declaration b on b.id
		= a.declaration_id
		LEFT JOIN textbook C ON C.ID=A.textbook_id
		WHERE B.ID
		IS NOT NULL and c.id is not null
		AND b.is_staging =false and
		b.online_progress != 2
		AND A.chosen_position IN (1,2,3) AND
		C.is_published = true
		AND B.org_id = #{orgId}
		AND C.ID IN
		<foreach collection="list" item="item" index="index" open="("
			close=")" separator=",">
			#{item}
		</foreach>
	</select>

	<!-- 教材申报-遴选主编/遴选编委(列表) -->
	<select id="listEditorSelection" parameterType="java.util.Map"
		resultType="DecPositionEditorSelectionVO">
		SELECT
			dp.`id` , dc.`realname`,dc.`sex`,
			org.`org_name` reportName,dc.`org_name`,
			dp.`preset_position`,
			( CASE
		      	WHEN 
		      		dp.`preset_position` =15 
		      	THEN 
		      		'主编,副主编,编委,数字编委'      
				WHEN 
					dp.`preset_position` =14 
				THEN 
					'主编,副主编,数字编委'          
				WHEN 
					dp.`preset_position` =13 
				THEN 
					'主编,编委,数字编委'            
				WHEN 
					dp.`preset_position` =12 
				THEN 
					'主编,数字编委'               
				WHEN 
					dp.`preset_position` =11 
				THEN 
					'副主编,编委,数字编委'         
				WHEN 
					dp.`preset_position` =10 
				THEN 
					'副主编,数字编委'              
				WHEN 
					dp.`preset_position` =9  
				THEN 
					'编委,数字编委'               
				WHEN 
					dp.`preset_position` =8  
				THEN 
					'数字编委'                   
				WHEN 
					dp.`preset_position` =7  
				THEN 
					'主编,副主编,编委'             
				WHEN 
					dp.`preset_position` =6  
				THEN 
					'主编,副主编'              
				WHEN 
					dp.`preset_position` =5  
				THEN 
					'主编,编委'                  
				WHEN 
					dp.`preset_position` =4  
				THEN 
					'主编'                      
				WHEN 
					dp.`preset_position` =3  
				THEN 
					'副主编,编委'                 
				WHEN 
					dp.`preset_position` =2  
				THEN 
					'副主编'                    
				WHEN 
					dp.`preset_position` =1  
				THEN 
					'编委'              
		      ELSE NULL 
		    END) strPresetPosition,
			dc.`online_progress`,
			dc.`id` declarationId, dc.`offline_progress`,
			dp.`chosen_position`, dp.`rank`,
			dp.`syllabus_id`,dp.`syllabus_name`
		FROM
			`dec_position` dp
		LEFT JOIN
			`declaration` dc
		ON
			dp.`declaration_id` = dc.`id`
		LEFT JOIN
			`org` org
		ON
			dc.`org_id`= org.`id` and dc.`online_progress` > 0 
		WHERE 
			<!-- dc.`online_progress` != 0 
		AND -->
			dc.`is_staging`= FALSE
		AND
			dp.`textbook_id` = #{textbookId}
		<if test="realName !=null and realName !=''">
			AND
				dc.`realname` like concat('%',#{realName},'%')
		</if>
		ORDER BY
		 dp.`rank` &lt; 1 DESC,
		 dp.`preset_position`=1 ASC,
		  dp.`chosen_position` =1 DESC,
		  dp.`gmt_create` DESC 
			<!-- dp.`preset_position` DESC,dp.`rank`=1 DESC,dp.`chosen_position` =1 DESC,dp.`gmt_create` DESC -->
	</select>

	<!-- 教材申报-遴选主编/遴选编委(更新) -->
	<update id="updateDecPositionEditorSelection" parameterType="java.util.List">
		<foreach item="item" collection="list" index="index" open=""
			separator=";">
			update
			dec_position
			<set>
				<if test="item.chosenPosition !=null">
					chosen_position = #{item.chosenPosition},
				</if>
				<if test="item.rank !=null">
					rank = #{item.rank},
				</if>
				<!-- <if test="item.isDigitalEditor !=null">
					is_digital_editor = #{item.isDigitalEditor},
				</if> -->
			</set>
			where
			id=#{item.id}
		</foreach>
	</update>
	
	<!-- 教材申报-遴选主编/遴选编委 (根据书籍Id查询所有申报id) -->
	<select id="getDecPositionIdByBookId" parameterType="java.util.Map" resultType="java.lang.Long">
		select 
			dp.`id`
		FROM 
			`dec_position` dp
		WHERE 
			1=1
			<if test="editorOrSubeditorType ==1">
			AND	
				dp.`chosen_position` IN (4,2,8)
			</if>
			<if test="editorOrSubeditorType ==2">
			AND
				dp.`chosen_position`IN (1,8)
			</if>
			AND 
				dp.`textbook_id` = #{textbookId};
	</select>
	
	<!-- 教材申报-遴选主编/遴选编委 (更新前先初始化) -->
	<update id="updateDecPositionSetDefault" parameterType="java.util.Map">
		UPDATE 
			`dec_position` dp 
			<set>
				<if test="editorOrSubeditorType !=null">
					<if test="editorOrSubeditorType ==1">
						dp.`chosen_position`=0,
						dp.`rank`=NULL
					</if>
					<if test="editorOrSubeditorType ==2">
						dp.`chosen_position`=0
					</if>
				</if>
			</set>
		WHERE 
			dp.`id` IN 
		 	<foreach collection="ids" index="index" item="id" separator="," open="(" close=")">
           		#{id}
        	</foreach>
	</update>

	<!-- 根据declarationId查询作家申报职位信息并显示图书名字 -->
	<select id="listDecPositionsOrBook" parameterType="java.lang.Long"
		resultType="DecPositionDisplayVO">
		select *,tb.textbook_name 
		<!-- case 
		when dp.preset_position = 15 then '主编,副主编,编委,数字编委' 
		when dp.preset_position = 14 then '主编,副主编,数字编委' 
		when dp.preset_position = 13 then '主编,编委,数字编委' 
		when dp.preset_position = 12 then '主编,数字编委' 
		when dp.preset_position = 11 then '副主编,编委,数字编委' 
		when dp.preset_position = 10 then '副主编,数字编委' 
		when dp.preset_position = 9 then '编委,数字编委' 
		when dp.preset_position = 8 then '数字编委' 
		when dp.preset_position = 7 then '主编,副主编,编委' 
		when dp.preset_position = 6 then '主编,副主编' 
		when dp.preset_position = 5 then '主编,编委' 
		when dp.preset_position = 4 then '主编' 
		when dp.preset_position = 3 then '副主编,编委' 
		when dp.preset_position = 2 then '副主编' 
		when dp.preset_position = 1 then '编委' 
		else null end preset_positions,
		case 
		when dp.chosen_position = 12 then '主编,数字编委' 
		when dp.chosen_position = 10 then '副主编,数字编委' 
		when dp.chosen_position = 9 then '编委,数字编委' 
		when dp.chosen_position = 8 then '数字编委' 
		when dp.chosen_position = 4 then '主编' 
		when dp.chosen_position = 2 then '副主编' 
		when dp.chosen_position = 1 then '编委' 
		else null end chosen_positions  -->
		from dec_position dp 
		left join textbook tb on tb.id=dp.textbook_id 
		where 
		declaration_id=#{declarationId};
	</select>
	<!-- 根据materialId查询学校申报总数 -->
    <select id="getSchoolDeclarationCount" parameterType="java.lang.Long" 
        resultType="java.lang.Integer">
        SELECT count(a.preset_position) count 
		FROM dec_position a 
		LEFT JOIN declaration b ON a.declaration_id = b.id 
		LEFT JOIN material c ON b.material_id = c.id 
		LEFT JOIN org d ON b.org_id = d.id 
		WHERE a.preset_position IS NOT NULL AND c.id = #{materialId} 
		AND b.is_staging = 0 AND b.online_progress > 0 ;
    </select>
    
    <!-- 根据materialId查询学校当选总数 -->
    <select id="getSchoolDeclarationChosenCount" parameterType="java.lang.Long"
        resultType="java.lang.Integer">
        SELECT count(a.chosen_position) count 
		FROM dec_position a 
		LEFT JOIN declaration b ON a.declaration_id = b.id 
		LEFT JOIN textbook c ON a.textbook_id = c.id 
		LEFT JOIN material d ON b.material_id = d.id 
		LEFT JOIN org e ON b.org_id = e.id 
		WHERE a.chosen_position IS NOT NULL AND a.chosen_position !=0 
		AND c.is_published IS TRUE AND d.id = #{materialId} 
		AND b.is_staging = 0 AND b.online_progress = 3 ;
    </select>
    
    <!-- 根据materialId查询学校总数 -->
    <select id="getSchoolCount" parameterType="java.lang.Long" 
        resultType="java.lang.Integer">
        SELECT count(t.counts) FROM (SELECT count(a.preset_position) counts 
		FROM dec_position a 
		LEFT JOIN declaration b ON a.declaration_id = b.id 
		LEFT JOIN material c ON b.material_id = c.id 
		LEFT JOIN org d ON b.org_id = d.id 
		WHERE a.preset_position IS NOT NULL AND c.id = #{materialId} 
		AND b.is_staging = 0 AND b.online_progress > 0 
		GROUP BY b.org_id)t ;
    </select>
    <!-- 根据materialId查询主编申报总数 -->
    <select id="getEditorCount" parameterType="java.lang.Long" 
        resultType="java.lang.Integer">
        select sum(if((dp.preset_position in (4,5,6,7,12,13,14,15)),1,0)) count from dec_position dp 
        left join (select * from declaration) d on (d.id=dp.declaration_id) 
        left join (select id from material) m on (m.id=d.material_id) 
        where d.is_staging = 0 AND d.online_progress >0  
        and m.id=#{materialId};
    </select>
    <!-- 申报结果按学校统计（按申报数排序） -->
    <select id="getSchoolListPreset" parameterType="pageParameter" 
        resultType="DeclarationResultSchoolVO">
        SELECT * FROM(
        SELECT @rowno:=@rowno+1 AS row,t1.materialid,t1.orgid,t1.schoolname,t1.editorlist,
		t1.subeditorlist,t1.editoriallist,t1.isdigitaleditorlist    
		FROM (SELECT GROUP_CONCAT(if((a.chosen_position in (4) AND 
        c.is_published IS TRUE),b.realname,null)) editorlist,
		GROUP_CONCAT(if((a.chosen_position in (2) AND 
        c.is_published IS TRUE),b.realname,null)) subeditorlist,
		GROUP_CONCAT(if((a.chosen_position in (1) AND 
        c.is_published IS TRUE),b.realname,null)) editoriallist,
		GROUP_CONCAT(if((a.chosen_position in (8,9,10,11,12,13,14,15) AND 
        c.is_published IS TRUE),b.realname,null)) isdigitaleditorlist,
		d.id materialid,e.id orgid,e.org_name schoolname 
	    FROM dec_position a 
		LEFT JOIN declaration b ON a.declaration_id = b.id 
		LEFT JOIN textbook c ON a.textbook_id = c.id 
		LEFT JOIN material d ON c.material_id = d.id 
		LEFT JOIN (SELECT id,org_name FROM org UNION SELECT 0,'人民卫生出版社' FROM org)e 
		ON b.org_id = e.id 
		WHERE a.preset_position IS NOT NULL AND d.id = #{parameter.materialId} 
		AND b.is_staging = 0 AND b.online_progress >0 
		<if test="parameter.schoolName !=null and parameter.schoolName !=''">
		    and e.org_name like concat ('%',#{parameter.schoolName},'%') 
		</if>
		GROUP BY b.org_id ORDER BY SUM(if((a.preset_position in (4,5,6,7,12,13,14,15)),1,0)) DESC,
		SUM(if((a.preset_position in (2,3,6,7,10,11,14,15)),1,0)) DESC,
		SUM(if((a.preset_position in (1,3,5,7,9,11,13,15)),1,0)) DESC,
		SUM(if((a.preset_position in (8,9,10,11,12,13,14,15)),1,0)) DESC)t1,
		(SELECT @rowno:=0)t2 )t3 
		<if test="start !=null and pageNumber != null">
			limit #{start},#{pageSize}
		</if>
		;
    </select>
    <!-- 查询结果按书籍统计 -->
    <select id="getBookList" parameterType="pageParameter" 
        resultType="DeclarationResultBookVO">
        SELECT * FROM(
        SELECT @rowno:=@rowno+1 AS row,t1.materialid,t1.id,t1.bookname,t1.editorlist,
		t1.subeditorlist,t1.editoriallist,t1.isdigitaleditorlist 
		FROM (SELECT GROUP_CONCAT(if((b.is_staging = 0 AND b.online_progress >0 AND 
        a.preset_position IS NOT NULL AND c.is_published IS TRUE AND 
        a.chosen_position in (4)),b.realname,null)) editorlist,
		GROUP_CONCAT(if((b.is_staging = 0 AND b.online_progress >0 AND 
        a.preset_position IS NOT NULL AND c.is_published IS TRUE AND 
        a.chosen_position in (2)),b.realname,null)) subeditorlist,
		GROUP_CONCAT(if((b.is_staging = 0 AND b.online_progress >0 AND 
        a.preset_position IS NOT NULL AND c.is_published IS TRUE AND 
        a.chosen_position in (1)),b.realname,null)) editoriallist,
 		GROUP_CONCAT(if((b.is_staging = 0 AND b.online_progress >0 AND 
        a.preset_position IS NOT NULL AND c.is_published IS TRUE AND 
        a.chosen_position in (8,9,10,11,12,13,14,15)),b.realname,null)) isdigitaleditorlist,
		d.id materialid,c.id id,c.textbook_name bookname 
		FROM dec_position a 
		LEFT JOIN declaration b ON a.declaration_id = b.id 
		LEFT JOIN textbook c ON a.textbook_id = c.id 
		LEFT JOIN material d ON c.material_id = d.id   
		WHERE d.id = #{parameter.materialId} 
		<if test="parameter.bookName !=null and parameter.bookName !=''">
		    and c.textbook_name like concat ('%',#{parameter.bookName},'%') 
		</if>
        GROUP BY c.id ORDER BY c.sort ASC)t1,
	    (SELECT @rowno:=0)t2 )t3 
	    <if test="start !=null and pageNumber != null">
			limit #{start},#{pageSize}
		</if>
		;
    </select>
    <!-- 根据书籍id查询主编和副主编、编委-->
    <select id="getTextbookEditorList" parameterType="java.lang.Long" 
     	resultType="TextbookDecVO">
     	SELECT 
     		dc.`user_id`, wu.`username`,dc.`realname`,wu.`is_writer`,
 			dc.`org_name`,dp.`preset_position`,dp.`chosen_position`,
 			wu.`rank`,dp.`textbook_id`
 		FROM `dec_position` dp 
 		LEFT JOIN `declaration` dc ON dp.`declaration_id` = dc.`id`
 		LEFT JOIN `org` org ON dc.`org_id`= org.`id`
 		LEFT JOIN `writer_user` wu ON wu.`id`= dc.`user_id`
 		WHERE
 			dc.is_staging=false 
 			and dc.online_progress!=2
 			and dp.`textbook_id` =#{textBookId}
     </select>

	<!-- 根据materialId查询副主编申报总数 -->
	<select id="getSubEditorCount" parameterType="java.lang.Long"
		resultType="java.lang.Integer">
		SELECT sum(if((dp.preset_position in (2,3,6,7,10,11,14,15)),1,0)) count FROM dec_position dp 
		LEFT JOIN (select * FROM declaration) d ON (d.id=dp.declaration_id) 
		LEFT JOIN (select id FROM material) m ON (m.id=d.material_id) 
		WHERE d.is_staging = 0 AND d.online_progress >0 
		AND m.id=#{materialId};
	</select>
	<!-- 根据materialId查询编委申报数 -->
	<select id="getEditorialCount" parameterType="java.lang.Long"
		resultType="java.lang.Integer">
		select sum(if((dp.preset_position in (1,3,5,7,9,11,13,15)),1,0)) count from dec_position dp 
		left join (select * from declaration) d on (d.id=dp.declaration_id) 
		left join (select id from material) m on (m.id=d.material_id) 
		where d.is_staging = 0 AND d.online_progress >0 
		and m.id=#{materialId};
	</select>
	
	<!-- 根据materialId查询数字编委申报数 -->
	<select id="getDigitalCount" parameterType="java.lang.Long" 
	    resultType="java.lang.Integer">
	    select sum(if((dp.preset_position in (8,9,10,11,12,13,14,15)),1,0)) count from dec_position dp 
		left join (select * from declaration) d on (d.id=dp.declaration_id) 
		left join (select id from material) m on (m.id=d.material_id) 
		where d.is_staging = 0 AND d.online_progress >0 
		and m.id=#{materialId};
	</select>
	
	<!-- 根据materialId查询主编当选数 -->
	<select id="getChosenEditorCount" parameterType="java.lang.Long" 
	    resultType="java.lang.Integer">
	    select sum(if((dp.chosen_position = 4) AND n.is_published IS TRUE,1,0)) count 
	    from dec_position dp 
		left join (select * from declaration) d on (d.id=dp.declaration_id) 
		left join (select id from material) m on (m.id=d.material_id) 
		LEFT JOIN (SELECT id,is_published FROM textbook) n ON (n.id = dp.textbook_id)
		where d.is_staging = 0 AND d.online_progress = 3 
		and m.id= #{materialId};
	</select>
	
	<!-- 根据materialId查询副主编当选数 -->
	<select id="getChosenSubeditorCount" parameterType="java.lang.Long" 
	    resultType="java.lang.Integer">
	    select sum(if((dp.chosen_position = 2) AND n.is_published IS TRUE,1,0)) count 
	    from dec_position dp 
		left join (select * from declaration) d on (d.id=dp.declaration_id) 
		left join (select id from material) m on (m.id=d.material_id) 
		LEFT JOIN (SELECT id,is_published FROM textbook) n ON (n.id = dp.textbook_id)
		where d.is_staging = 0 AND d.online_progress = 3 
		and m.id= #{materialId};
	</select>
	
	<!-- 根据materialId查询编委当选数 -->
	<select id="getChosenEditorialCount" parameterType="java.lang.Long" 
	    resultType="java.lang.Integer">
	    select sum(if((dp.chosen_position = 1) AND n.is_published IS TRUE,1,0)) count 
	    from dec_position dp 
		left join (select * from declaration) d on (d.id=dp.declaration_id) 
		left join (select id from material) m on (m.id=d.material_id) 
		LEFT JOIN (SELECT id,is_published FROM textbook) n ON (n.id = dp.textbook_id)
		where d.is_staging = 0 AND d.online_progress = 3 
		and m.id= #{materialId};
	</select>
	
	<!-- 根据materialId查询数字编委当选数 -->
	<select id="getChosenDigitalCount" parameterType="java.lang.Long" 
	    resultType="java.lang.Integer">
	    select sum(if((dp.chosen_position in (8,9,10,11,12,13,14,15) AND n.is_published IS TRUE),1,0)) count 
	    from dec_position dp 
		left join (select * from declaration) d on (d.id=dp.declaration_id) 
		left join (select id from material) m on (m.id=d.material_id) 
		LEFT JOIN (SELECT id,is_published FROM textbook) n ON (n.id = dp.textbook_id)
		where d.is_staging = 0 AND d.online_progress = 3 
		and m.id= #{materialId};
	</select>
	
	<!-- 申报情况按学校统计（按当选数排序） -->
	<select id="getSchoolResultChosen" parameterType="pageParameter"
		resultType="DeclarationSituationSchoolResultVO">
		SELECT * FROM(
		SELECT @rowno:=@rowno+1 AS row,t1.materialid,t1.orgid,t1.schoolname,t1.presetpositioneditor,
		t1.presetpositionsubeditor,t1.presetpositioneditorial,t1.presetdigitaleditor,
		t1.chosenpositioneditor,t1.chosenpositionsubeditor,t1.chosenpositioneditorial,t1.isdigitaleditor 
		FROM (SELECT sum(if((a.preset_position in (4,5,6,7,12,13,14,15)),1,0)) presetpositioneditor,
		SUM(if((a.preset_position in (2,3,6,7,10,11,14,15)),1,0)) presetpositionsubeditor,
		SUM(if((a.preset_position in (1,3,5,7,9,11,13,15)),1,0)) presetpositioneditorial,
		SUM(if((a.preset_position in (8,9,10,11,12,13,14,15)),1,0)) presetdigitaleditor,
		SUM(if((a.chosen_position in (4) AND c.is_published IS TRUE),1,0)) chosenpositioneditor,
		SUM(if((a.chosen_position in (2) AND c.is_published IS TRUE),1,0)) chosenpositionsubeditor,
		SUM(if((a.chosen_position in (1) AND c.is_published IS TRUE),1,0)) chosenpositioneditorial,
		SUM(if((a.chosen_position in (8,9,10,11,12,13,14,15) AND c.is_published IS TRUE),1,0)) isdigitaleditor,
		d.id materialid,e.id orgid,e.org_name schoolname 
		FROM dec_position a 
		LEFT JOIN declaration b ON a.declaration_id = b.id 
		LEFT JOIN textbook c ON a.textbook_id = c.id 
		LEFT JOIN material d ON c.material_id = d.id 
		LEFT JOIN (SELECT id,org_name FROM org UNION SELECT 0,'人民卫生出版社' FROM org)e 
		ON b.org_id = e.id 
		WHERE a.preset_position IS NOT NULL AND d.id = #{parameter.materialId} 
		AND b.is_staging = 0 AND b.online_progress >0 
		<if test="parameter.schoolName !=null and parameter.schoolName !=''">
			and e.org_name like concat ('%',#{parameter.schoolName},'%') 
		</if>
		GROUP BY e.id ORDER BY SUM(if((a.chosen_position in (4)),1,0)) DESC, 
		SUM(if((a.chosen_position in (2)),1,0)) DESC, 
		SUM(if((a.chosen_position in (1)),1,0)) DESC, 
		SUM(if((a.chosen_position in (8,9,10,11,12,13,14,15)),1,0)) DESC)t1,
		(SELECT @rowno:=0)t2 )t3 
		<if test="start !=null and pageNumber != null">
			limit #{start},#{pageSize} 
		</if>
		;
	</select>
	<!-- 申报情况按学校统计（按申报数数排序） -->
	<select id="getSchoolResultPreset" parameterType="pageParameter"
		resultType="DeclarationSituationSchoolResultVO">
		SELECT * FROM(
		SELECT @rowno:=@rowno+1 AS row,t1.materialid,t1.orgid,t1.schoolname,t1.presetpositioneditor,
		t1.presetpositionsubeditor,t1.presetpositioneditorial,t1.presetdigitaleditor,
		t1.chosenpositioneditor,t1.chosenpositionsubeditor,t1.chosenpositioneditorial,t1.isdigitaleditor 
		FROM (SELECT sum(if((a.preset_position in (4,5,6,7,12,13,14,15)),1,0)) presetpositioneditor,
		SUM(if((a.preset_position in (2,3,6,7,10,11,14,15)),1,0)) presetpositionsubeditor,
		SUM(if((a.preset_position in (1,3,5,7,9,11,13,15)),1,0)) presetpositioneditorial,
		SUM(if((a.preset_position in (8,9,10,11,12,13,14,15)),1,0)) presetdigitaleditor,
		SUM(if((a.chosen_position in (4) AND c.is_published IS TRUE),1,0)) chosenpositioneditor,
		SUM(if((a.chosen_position in (2) AND c.is_published IS TRUE),1,0)) chosenpositionsubeditor,
		SUM(if((a.chosen_position in (1) AND c.is_published IS TRUE),1,0)) chosenpositioneditorial,
		SUM(if((a.chosen_position in (8,9,10,11,12,13,14,15) AND c.is_published IS TRUE),1,0)) isdigitaleditor,
		d.id materialid,e.id orgid,e.org_name schoolname 
		FROM dec_position a 
		LEFT JOIN declaration b ON a.declaration_id = b.id 
		LEFT JOIN textbook c ON a.textbook_id = c.id 
		LEFT JOIN material d ON c.material_id = d.id 
		LEFT JOIN (SELECT id,org_name FROM org UNION SELECT 0,'人民卫生出版社' FROM org)e 
		ON b.org_id = e.id 
		WHERE a.preset_position IS NOT NULL AND d.id = #{parameter.materialId} 
		AND b.is_staging = 0 AND b.online_progress >0 
		<if test="parameter.schoolName !=null and parameter.schoolName !=''">
			and e.org_name like concat ('%',#{parameter.schoolName},'%') 
		</if>
		GROUP BY e.id ORDER BY SUM(if((a.preset_position in (4,5,6,7,12,13,14,15)),1,0)) DESC,
		SUM(if((a.preset_position in (2,3,6,7,10,11,14,15)),1,0)) DESC,
		SUM(if((a.preset_position in (1,3,5,7,9,11,13,15)),1,0)) DESC,
		SUM(if((a.preset_position in (8,9,10,11,12,13,14,15)),1,0)) DESC)t1,
		(SELECT @rowno:=0)t2 )t3
		<if test="start !=null and pageNumber != null">
			limit #{start},#{pageSize} 
		</if>
		;
	</select>
	<select id="getBooks" parameterType="java.lang.Long" resultType="java.lang.Integer">
		SELECT COUNT(a.id) FROM textbook a WHERE a.material_id =
		#{materialId};
	</select>
	<!-- 申报情况按书籍统计 -->
	<select id="getBookResult" parameterType="pageParameter"
		resultType="DeclarationSituationBookResultVO">
		SELECT * FROM(
		SELECT @rowno:=@rowno+1 AS row,t1.materialid,t1.id,t1.bookname,t1.presetpositioneditor,
		t1.presetpositionsubeditor,t1.presetpositioneditorial,t1.presetdigitaleditor,
		t1.chosenpositioneditor,t1.chosenpositionsubeditor,t1.chosenpositioneditorial,t1.isdigitaleditor 
		FROM (SELECT sum(if((b.is_staging = 0 AND b.online_progress >0 AND 
        a.preset_position IS NOT NULL AND a.preset_position in (4,5,6,7,12,13,14,15)),1,0)) presetpositioneditor,
		SUM(if((b.is_staging = 0 AND b.online_progress >0 AND 
        a.preset_position IS NOT NULL AND a.preset_position in (2,3,6,7,10,11,14,15)),1,0)) presetpositionsubeditor,
		SUM(if((b.is_staging = 0 AND b.online_progress >0 AND 
        a.preset_position IS NOT NULL AND a.preset_position in (1,3,5,7,9,11,13,15)),1,0)) presetpositioneditorial,
        SUM(if((b.is_staging = 0 AND b.online_progress >0 AND 
        a.preset_position IS NOT NULL AND a.preset_position in (8,9,10,11,12,13,14,15)),1,0)) presetdigitaleditor,
		SUM(if((b.is_staging = 0 AND b.online_progress >0 AND 
        a.preset_position IS NOT NULL AND c.is_published IS TRUE AND 
        a.chosen_position in (4)),1,0)) chosenpositioneditor,
		SUM(if((b.is_staging = 0 AND b.online_progress >0 AND 
        a.preset_position IS NOT NULL AND c.is_published IS TRUE AND 
        a.chosen_position in (2)),1,0)) chosenpositionsubeditor,
		SUM(if((b.is_staging = 0 AND b.online_progress >0 AND 
        a.preset_position IS NOT NULL AND c.is_published IS TRUE AND 
        a.chosen_position in (1)),1,0)) chosenpositioneditorial,
		SUM(if((b.is_staging = 0 AND b.online_progress >0 AND 
        a.preset_position IS NOT NULL AND c.is_published IS TRUE AND 
        a.chosen_position in (8,9,10,11,12,13,14,15)),1,0)) isdigitaleditor,
		d.id materialid,c.id id,c.textbook_name bookname 
		FROM dec_position a 
		LEFT JOIN declaration b ON a.declaration_id = b.id 
		LEFT JOIN textbook c ON a.textbook_id = c.id 
		LEFT JOIN material d ON c.material_id = d.id 
		WHERE d.id = #{parameter.materialId} 
		<if test="parameter.bookName !=null and parameter.bookName !=''">
			and c.textbook_name like concat ('%',#{parameter.bookName},'%') 
		</if>
		GROUP BY c.id ORDER BY c.sort ASC)t1, (SELECT @rowno:=0)t2 )t3 
		<if test="start !=null and pageNumber != null">
			limit #{start},#{pageSize} 
		</if>
		;
	</select>
	<!-- 申报结果按学校统计（按当选数排序） -->
	<select id="getSchoolListChosen" parameterType="pageParameter"
		resultType="DeclarationResultSchoolVO">
		SELECT * FROM(
		SELECT @rowno:=@rowno+1 AS row,t1.materialid,t1.orgid,t1.schoolname,t1.editorlist,
		t1.subeditorlist,t1.editoriallist,t1.isdigitaleditorlist 
		FROM (SELECT GROUP_CONCAT(if((a.chosen_position in (4) AND 
        c.is_published IS TRUE),b.realname,null)) editorlist,
		GROUP_CONCAT(if((a.chosen_position in (2) AND 
        c.is_published IS TRUE),b.realname,null)) subeditorlist,
		GROUP_CONCAT(if((a.chosen_position in (1) AND 
        c.is_published IS TRUE),b.realname,null)) editoriallist,
		GROUP_CONCAT(if((a.chosen_position in (8,9,10,11,12,13,14,15) AND 
        c.is_published IS TRUE),b.realname,null)) isdigitaleditorlist,
		d.id materialid,e.id orgid,e.org_name schoolname 
	    FROM dec_position a 
		LEFT JOIN declaration b ON a.declaration_id = b.id 
		LEFT JOIN textbook c ON a.textbook_id = c.id 
		LEFT JOIN material d ON c.material_id = d.id 
		LEFT JOIN (SELECT id,org_name FROM org UNION SELECT 0,'人民卫生出版社' FROM org)e 
	    ON b.org_id = e.id 
		WHERE a.preset_position IS NOT NULL AND d.id = #{parameter.materialId} 
		AND b.is_staging = 0 AND b.online_progress >0 
		<if test="parameter.schoolName !=null and parameter.schoolName !=''">
			and e.org_name like concat ('%',#{parameter.schoolName},'%') 
		</if>
		GROUP BY e.id ORDER BY SUM(if((a.chosen_position in (4)),1,0)) DESC,
		SUM(if((a.chosen_position in (2)),1,0)) DESC,
		SUM(if((a.chosen_position in (1)),1,0)) DESC,
		SUM(if((a.chosen_position in (8,9,10,11,12,13,14,15)),1,0)) DESC)t1,
		(SELECT @rowno:=0)t2 )t3 
		<if test="start !=null and pageNumber != null">
			limit #{start},#{pageSize} 
		</if>
		;
	</select>
		
	<!-- 根据书籍id查询 -->
	<select id="getDecPositionByTextbookId" parameterType="java.lang.Long"
		resultType="DecPosition">
		select * from dec_position dp
		where dp.chosen_position in (1,3,5,7,9,10,11,12,13,14,15)
			  and dp.textbook_id=#{textbookId}
	</select>
</mapper>
