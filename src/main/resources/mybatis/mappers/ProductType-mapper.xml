<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.bc.pmpheep.back.dao.ProductTypeDao">

    <resultMap id="ProductTypeMap" type="com.bc.pmpheep.back.vo.ProductType">
        <id property="id" column="id"></id>
        <result property="parent_id" column="parent_id"></result>
        <result property="type_name" column="type_name"></result>
        <result property="typeType" column="typeType"></result>
    </resultMap>

    <select id="getSubjectTypeList" parameterType="PageParameter" resultMap="ProductTypeMap">
        select *,1 as typeType from
        product_subject_type
        <where>
            is_deleted = 0
            <if test="parameter.type_name != null and parameter.type_name != '' ">
                and type_name like concat('%',#{parameter.type_name},'%')
            </if>
        </where>
        limit #{start},#{pageSize}
    </select>

    <select id="getSubjectTypeCount" parameterType="PageParameter" resultType="int">
        select count(id) from
        product_subject_type
        <where>
            is_deleted = 0
            <if test="parameter.type_name != null and parameter.type_name != '' ">
                and type_name like concat('%',#{parameter.type_name},'%')
            </if>
        </where>
    </select>

    <select id="getLeafContentTypeList" parameterType="PageParameter" resultMap="ProductTypeMap">
        select
        t.id as id
        ,d.name_path as type_name
        ,t.parent_id as parent_id
        ,2 as typeType
        from
        product_content_type_detail d
        inner join product_content_type t on d.product_type_id = t.id and d.is_deleted = 0 and t.is_deleted = 0
        <where>
            d.is_leaf = 1
            <if test="parameter.type_name != null and parameter.type_name != '' ">
                and d.name_path like concat('%',#{parameter.type_name},'%')
            </if>
        </where>
        limit #{start},#{pageSize}
    </select>

    <select id="getLeafContentTypeCount" parameterType="PageParameter" resultType="int">
        select
        COUNT(d.id)
        from
        product_content_type_detail d
        <where>
            d.is_deleted = 0
            and d.is_leaf = 1
            <if test="parameter.type_name != null and parameter.type_name != '' ">
                and d.name_path like concat('%',#{parameter.type_name},'%')
            </if>
        </where>
    </select>

    <update id="deleteSubjectTypeById" parameterType="java.lang.Long" >
        update product_subject_type set is_deleted = 1 where id = #{id}
    </update>

    <update id="deleteLeafContentTypeById" parameterType="java.lang.Long">
        update product_content_type        set is_deleted = 1 where id = #{id};
        update product_content_type_detail set is_deleted = 1 where product_type_id = #{id};
        /*更新叶子节点*/
        update product_content_type_detail dp left join product_content_type t on t.parent_id = dp.product_type_id and t.is_deleted = 0
        set dp.is_leaf = isNull(t.id);

    </update>

    <update id="refreshLeafOfContentType" >
        /*更新叶子节点*/
        update product_content_type_detail dp left join product_content_type t on t.parent_id = dp.product_type_id and t.is_deleted = 0
        set dp.is_leaf = isNull(t.id);
    </update>

    <select id="getSubjectTypeExpertationCount" parameterType="java.lang.Long" resultType="java.lang.Integer">
        select count(e.id)
        from
        (
        select expertation_id from
        expertation_subject_type where product_subject_type_id = #{id}
        )t
        inner join expertation e on e.id = t.expertation_id
    </select>

    <select id="getContentTypeExpertationCount" parameterType="java.lang.Long" resultType="java.lang.Integer">
        select count(e.id)
        from
        (
        select expertation_id from
        expertation_content_type where product_content_type_id = #{id}
        )t
        inner join expertation e on e.id = t.expertation_id
    </select>

</mapper>