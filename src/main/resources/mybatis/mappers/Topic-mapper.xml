<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.bc.pmpheep.back.dao.TopicDao">

	<sql id="key">
		<!-- 去掉最后一个, -->
		<trim suffixOverrides=",">
			<if test="userId != null">
				user_id,
			</if>
			<if test="bookname != null and bookname !='' ">
				bookname,
			</if>
			<if test="reader != null ">
				reader,
			</if>
			<if test="deadline != null ">
				deadline,
			</if>
			<if test="source != null">
				source,
			</if>
			<if test="wordNumber != null">
				word_number,
			</if>
			<if test="pictureNumber != null">
				picture_number,
			</if>
			<if test="subject != null and subject !='' ">
				subject,
			</if>
			<if test="rank != null">
				rank,
			</if>
			<if test="type != null">
				type,
			</if>
			<if test="bankAccountId != null">
				bank_account_id,
			</if>
			<if test="purchase != null">
				purchase,
			</if>
			<if test="sponsorship != null">
				sponsorship,
			</if>
			<if test="isTranslation != null">
				is_translation,
			</if>
			<if test="originalBookname != null and originalBookname !='' ">
				original_bookname,
			</if>
			<if test="originalAuthor != null and originalAuthor !='' ">
				original_author,
			</if>
			<if test="nation != null and nation !='' ">
				nation,
			</if>
			<if test="edition != null and edition !='' ">
				edition,
			</if>
			<if test="authProgress != null">
				auth_progress,
			</if>
			<if test="authFeedback != null and authFeedback !='' ">
				auth_feedback,
			</if>
			<if test="authDate != null">
				auth_date,
			</if>
			<if test="isOptsHandling != null">
				is_opts_handling,
			</if>
			<if test="optsRoleId != null">
				opts_role_id,
			</if>
			<if test="isRejectedByDirector != null">
				is_rejected_by_director,
			</if>
			<if test="reasonDirector != null and reasonDirector !='' ">
				reason_director,
			</if>
			<if test="isDirectorHandling != null">
				is_director_handling,
			</if>
			<if test="departmentId != null">
				department_id,
			</if>
			<if test="isRejectedByEditor != null">
				is_rejected_by_editor,
			</if>
			<if test="reasonEditor != null and reasonEditor !='' ">
				reason_editor,
			</if>
			<if test="isEditorHandling != null">
				is_editor_handling,
			</if>
			<if test="editorId != null">
				editor_id,
			</if>
			<if test="isAccepted != null">
				is_accepted,
			</if>
			<if test="isStaging != null">
				is_staging,
			</if>
			<if test="isDeleted != null">
				is_deleted,
			</if>
			<if test="note != null and note !='' ">
				note,
			</if>
			<if test="gmtCreate != null">
				gmt_create,
			</if>
			<if test="gmtUpdate != null">
				gmt_update,
			</if>
			<if test="vn != null and vn !='' ">
				vn,
			</if>
			<if test="tn != null and tn !='' ">
				tn,
			</if>
			<if test="submitTime != null">
				submit_time,
			</if>
		</trim>
	</sql>
	<sql id="value">
		<!-- 去掉最后一个, -->
		<trim suffixOverrides=",">
			<if test="userId != null">
				#{userId},
			</if>
			<if test="bookname != null and bookname !='' ">
				#{bookname},
			</if>
			<if test="reader != null ">
				#{reader},
			</if>
			<if test="deadline != null ">
				#{deadline},
			</if>
			<if test="source != null">
				#{source},
			</if>
			<if test="wordNumber != null">
				#{wordNumber},
			</if>
			<if test="pictureNumber != null">
				#{pictureNumber},
			</if>
			<if test="subject != null and subject !='' ">
				#{subject},
			</if>
			<if test="rank != null">
				#{rank},
			</if>
			<if test="type != null">
				#{type},
			</if>
			<if test="bankAccountId != null">
				#{bankAccountId},
			</if>
			<if test="purchase != null">
				#{purchase},
			</if>
			<if test="sponsorship != null">
				#{sponsorship},
			</if>
			<if test="isTranslation != null">
				#{isTranslation},
			</if>
			<if test="originalBookname != null and originalBookname !='' ">
				#{originalBookname},
			</if>
			<if test="originalAuthor != null and originalAuthor !='' ">
				#{originalAuthor},
			</if>
			<if test="nation != null and nation !='' ">
				#{nation},
			</if>
			<if test="edition != null and edition !='' ">
				#{edition},
			</if>
			<if test="authProgress != null">
				#{authProgress},
			</if>
			<if test="authFeedback != null and authFeedback !='' ">
				#{authFeedback},
			</if>
			<if test="authDate != null">
				#{authDate},
			</if>
			<if test="isOptsHandling != null">
				#{isOptsHandling},
			</if>
			<if test="optsRoleId != null">
				#{optsRoleId},
			</if>
			<if test="isRejectedByDirector != null">
				#{isRejectedByDirector},
			</if>
			<if test="reasonDirector != null and reasonDirector !='' ">
				#{reasonDirector},
			</if>
			<if test="isDirectorHandling != null">
				#{isDirectorHandling},
			</if>
			<if test="departmentId != null">
				#{departmentId},
			</if>
			<if test="isRejectedByEditor != null">
				#{isRejectedByEditor},
			</if>
			<if test="reasonEditor != null and reasonEditor !='' ">
				#{reasonEditor},
			</if>
			<if test="isEditorHandling != null">
				#{isEditorHandling},
			</if>
			<if test="editorId != null">
				#{editorId},
			</if>
			<if test="isAccepted != null">
				#{isAccepted},
			</if>
			<if test="isStaging != null">
				#{isStaging},
			</if>
			<if test="isDeleted != null">
				#{isDeleted},
			</if>
			<if test="note != null and note !='' ">
				#{note},
			</if>
			<if test="gmtCreate != null">
				#{gmtCreate},
			</if>
			<if test="gmtUpdate != null">
				#{gmtUpdate},
			</if>
			<if test="vn != null and vn !='' ">
				#{vn},
			</if>
			<if test="tn != null and tn !='' ">
				#{tn},
			</if>
			<if test="submitTime != null">
				#{submitTime},
			</if>
		</trim>
	</sql>

	<!-- 新增一个topic -->
	<insert id="add" parameterType="Topic">
		<selectKey resultType="java.lang.Long" order="AFTER"
			keyProperty="id"> <!-- order="AFTER"表示先执行插入语句，之后再执行查询语句 BEFORE 或 AFTER -->
			SELECT LAST_INSERT_ID()
		</selectKey>
		insert into topic (
		<include refid="key" />
		)
		values(
		<include refid="value" />
		);
	</insert>

	<!-- 运维人员获取可以操作的选题 -->
	<select id="listOpts" resultType="TopicOPtsManagerVO">
		SELECT
		t.*,w.realname
		FROM
		topic t
		LEFT JOIN pmph_user_role r ON r.role_id
		=
		t.opts_role_id
		LEFT JOIN pmph_user u ON u.id = r.user_id
		LEFT JOIN
		writer_user w ON t.user_id = w.id
		WHERE u.id =
		#{userId}
		AND
		t.is_opts_handling = TRUE
		AND t.is_director_handling =
		FALSE
		<if test="bookname != null and bookname !=''">
			AND t.bookname like concat('%',#{bookname},'%')
		</if>
		<if test="submitTime != null">
			AND t.submit_time = #{submitTime}
		</if>
		ORDER BY t.submit_time
		LIMIT
		#{start},#{pageSize}
	</select>

	<!-- 查询运维人员可以操作的数量 -->
	<select id="listOptsTotal" resultType="Integer">
		SELECT
		count(*)
		FROM
		topic t
		LEFT JOIN pmph_user_role r ON r.role_id =
		t.opts_role_id
		LEFT JOIN pmph_user u ON u.id = r.user_id
		LEFT JOIN
		writer_user w ON t.user_id = w.id
		WHERE u.id =
		#{userId}
		AND
		t.is_opts_handling = TRUE
		AND t.is_director_handling =
		FALSE
		<if test="bookname != null and bookname !=''">
			AND t.bookname like concat('%',#{bookname},'%')
		</if>
		<if test="submitTime != null">
			AND t.submit_time = #{submitTime}
		</if>
		ORDER BY t.submit_time
	</select>

	<!-- 系统管理员获取可以操作的选题 -->
	<select id="list" resultType="TopicOPtsManagerVO">
		SELECT
		t.*,w.realname
		FROM
		topic t
		LEFT JOIN
		writer_user w ON t.user_id =
		w.id
		WHERE
		t.is_opts_handling = TRUE
		AND
		t.is_director_handling = FALSE
		<if test="bookname != null and bookname !=''">
			AND t.bookname like concat('%',#{bookname},'%')
		</if>
		<if test="submitTime != null">
			AND t.submit_time = #{submitTime}
		</if>
		ORDER BY t.submit_time
		LIMIT
		#{start},#{pageSize}
	</select>

	<!-- 系统管理员可以操作的数量 -->
	<select id="listTotal" resultType="Integer">
		SELECT
		count(*)
		FROM
		topic t
		LEFT JOIN
		writer_user w ON t.user_id = w.id
		WHERE
		t.is_opts_handling = TRUE
		AND
		t.is_director_handling =
		FALSE
		<if test="bookname != null and bookname !=''">
			AND t.bookname like concat('%',#{bookname},'%')
		</if>
		<if test="submitTime != null">
			AND t.submit_time = #{submitTime}
		</if>
		ORDER BY t.submit_time
	</select>
	<!-- 动态修改选题申报 -->
	<update id="update" parameterType="Topic">
		UPDATE topic
		<set>
			<if test="userId != null">
				user_id = #{userId},
			</if>
			<if test="bookname != null and bookname !='' ">
				bookname = #{bookname},
			</if>
			<if test="reader != null ">
				reader = #{reader},
			</if>
			<if test="deadline != null ">
				deadline = #{deadline},
			</if>
			<if test="source != null">
				source = #{source},
			</if>
			<if test="wordNumber != null">
				word_number =#{wordNumber},
			</if>
			<if test="pictureNumber != null">
				picture_number =#{pictureNumber},
			</if>
			<if test="subject != null and subject !='' ">
				subject = #{subject},
			</if>
			<if test="rank != null">
				rank = #{rank},
			</if>
			<if test="type != null">
				type = #{type},
			</if>
			<if test="bankAccountId != null">
				bank_account_id = #{bankAccountId},
			</if>
			<if test="purchase != null">
				purchase = #{purchase},
			</if>
			<if test="sponsorship != null">
				sponsorship = #{sponsorship},
			</if>
			<if test="isTranslation != null">
				is_translation = #{isTranslation},
			</if>
			<if test="originalBookname != null and originalBookname !='' ">
				original_bookname = #{originalBookname},
			</if>
			<if test="originalAuthor != null and originalAuthor !='' ">
				original_author = #{originalAuthor},
			</if>
			<if test="nation != null and nation !='' ">
				nation = #{nation},
			</if>
			<if test="edition != null and edition !='' ">
				edition = #{edition},
			</if>
			<if test="authProgress != null">
				auth_progress = #{authProgress},
			</if>
			<if test="authFeedback != null and authFeedback !='' ">
				auth_feedback = #{authFeedback},
			</if>
			<if test="authDate != null">
				auth_date = #{authDate},
			</if>
			<if test="isOptsHandling != null">
				is_opts_handling = #{isOptsHandling},
			</if>
			<if test="optsRoleId != null">
				opts_role_id = #{optsRoleId},
			</if>
			<if test="isRejectedByDirector != null">
				is_rejected_by_director = #{isRejectedByDirector},
			</if>
			<if test="reasonDirector != null and reasonDirector !='' ">
				reason_director = #{reasonDirector},
			</if>
			<if test="isDirectorHandling != null">
				is_director_handling = #{isDirectorHandling},
			</if>
			<if test="departmentId != null">
				department_id = #{departmentId},
			</if>
			<if test="isRejectedByEditor != null">
				is_rejected_by_editor = #{isRejectedByEditor},
			</if>
			<if test="reasonEditor != null and reasonEditor !='' ">
				reason_editor = #{reasonEditor},
			</if>
			<if test="isEditorHandling != null">
				is_editor_handling = #{isEditorHandling},
			</if>
			<if test="editorId != null">
				editor_id = #{editorId},
			</if>
			<if test="isAccepted != null">
				is_accepted = #{isAccepted},
			</if>
			<if test="isStaging != null">
				is_staging = #{isStaging},
			</if>
			<if test="isDeleted != null">
				is_deleted = #{isDeleted},
			</if>
			<if test="note != null and note !='' ">
				note = #{note},
			</if>
			<if test="gmtCreate != null">
				gmt_create = #{gmtCreate},
			</if>
			<if test="gmtUpdate != null">
				gmt_update = #{gmtUpdate},
			</if>
			<if test="vn != null and vn !='' ">
				vn = #{vn},
			</if>
			<if test="tn != null and tn !='' ">
				tn = #{tn},
			</if>
			<if test="submitTime != null">
				submit_time = #{submitTime},
			</if>
		</set>
		WHERE id = #{id};
	</update>

	<select id="getTopicTextVO" parameterType="java.lang.Long"
		resultType="TopicTextVO">
		SELECT
		t.*, u.realname,u.username,a.bank,a.account_number
		FROM
		topic t
		LEFT JOIN pmph_user u ON u.id = t.editor_id
		LEFT JOIN
		writer_bank_account a ON a.id = t.bank_account_id
		LEFT JOIN writer_user
		w ON a.user_id = w.id WHERE t.id = #{id};
	</select>

	<select id="listCheckTopic" resultType="TopicDeclarationVO">
		SELECT
		t.*, w.realname,p.realname editorName
		FROM
		topic t
		LEFT JOIN
		writer_user w ON w.id = t.user_id
		LEFT JOIN pmph_user p ON p.id =
		t.editor_id
		WHERE
		t.auth_progress IN
		<foreach collection="authProgress" index="index" close=")"
			open="(" separator="," item="authProgress">
			#{authProgress}
		</foreach>
		<if test="bookname != null and bookname !=''">
			AND t.bookname like concat('%',#{bookname},'%')
		</if>
		<if test="submitTime != null">
			AND t.submit_time = #{submitTime}
		</if>
		ORDER BY t.submit_time
		limit
		#{start},#{pageSize}
	</select>

	<select id="listCheckTopicTotal" resultType="java.lang.Integer">
		SELECT count(*)
		FROM topic t LEFT JOIN writer_user w ON w.id =
		t.user_id LEFT JOIN pmph_user p ON p.id = t.editor_id WHERE
		t.auth_progress IN
		<foreach collection="authProgress" index="index" close=")"
			open="(" separator="," item="authProgress">
			#{authProgress}
		</foreach>
		<if test="bookname != null and bookname !=''">
			AND t.bookname like concat('%',#{bookname},'%')
		</if>
		<if test="submitTime != null">
			AND t.submit_time = #{submitTime}
		</if>
		ORDER BY t.submit_time
	</select>
	<!-- 获取主任可以操作的选题 -->
	<select id="listTopicDirectorVOs" resultType="TopicDirectorVO">
		SELECT a.*,c.realname
		FROM topic a LEFT JOIN pmph_user b ON
		a.department_id = b.department_id
		LEFT JOIN writer_user c ON a.user_id
		= c.id
		WHERE b.department_id = #{departmentId}
		AND
		a.is_director_handling = TRUE
		AND a.is_editor_handling = FALSE
		<if test="bookName != null and bookName !=''">
			AND a.bookname like concat('%',#{bookName},'%')
		</if>
		<if test="submitTime != null">
			AND a.submit_time = #{submitTime}
		</if>
		ORDER BY a.submit_time
		LIMIT
		#{start},#{pageSize}
	</select>

	<!-- 计算主任可以操作的选题数 -->
	<select id="totalTopicDirectorVOs" resultType="Integer">
		SELECT count(*) FROM (SELECT a.*,c.realname
		FROM topic a LEFT JOIN
		pmph_user b ON a.department_id
		= b.department_id
		LEFT JOIN writer_user c
		ON a.user_id = c.id
		WHERE
		b.department_id = #{departmentId}
		AND
		a.is_director_handling = TRUE
		AND
		a.is_editor_handling = FALSE
		<if test="bookName != null and bookName !=''">
			AND a.bookname like concat('%',#{bookName},'%')
		</if>
		<if test="submitTime != null">
			AND a.submit_time = #{submitTime}
		</if>
		ORDER BY a.submit_time) t
	</select>

	<!-- 获取编辑可以操作的申报选题 -->
	<select id="listTopicEditorVOs" resultType="TopicEditorVO">
		SELECT a.*,c.realname
		FROM topic a
		LEFT JOIN pmph_user b ON a.editor_id
		= b.id
		LEFT JOIN writer_user c ON a.user_id = c.id
		WHERE a.editor_id =
		#{userId}
		AND a.is_editor_handling = TRUE
		AND a.is_rejected_by_editor =
		FALSE
		<if test="bookName != null and bookName !=''">
			AND a.bookname like concat('%',#{bookName},'%')
		</if>
		<if test="submitTime != null">
			AND a.submit_time = #{submitTime}
		</if>
		ORDER BY a.submit_time
		LIMIT
		#{start},#{pageSize}
	</select>

	<!-- 计算编辑可以操作的选题数 -->
	<select id="totalTopicEditorVOs" resultType="Integer">
		SELECT count(*) FROM (SELECT a.*,b.realname
		FROM topic a
		LEFT JOIN
		pmph_user b ON a.editor_id =
		b.id
		LEFT JOIN writer_user c ON a.user_id =
		c.id
		WHERE a.editor_id =
		#{userId}
		AND a.is_editor_handling = TRUE
		AND
		a.is_rejected_by_editor =
		FALSE
		<if test="bookName != null and bookName !=''">
			AND a.bookname like concat('%',#{bookName},'%')
		</if>
		<if test="submitTime != null">
			AND a.submit_time = #{submitTime}
		</if>
		ORDER BY a.submit_time) t
	</select>

	<!-- 系统管理员查询选题申报（主任界面） -->
	<select id="listDirectorView" resultType="TopicDirectorVO">
		SELECT a.*,b.realname
		FROM topic a
		LEFT JOIN writer_user b ON a.user_id
		= b.id
		WHERE a.is_director_handling = TRUE
		AND a.is_editor_handling =
		FALSE
		<if test="bookName != null and bookName !=''">
			AND a.bookname like concat('%',#{bookName},'%')
		</if>
		<if test="submitTime != null">
			AND a.submit_time = #{submitTime}
		</if>
		ORDER BY a.submit_time
		LIMIT
		#{start},#{pageSize}
	</select>

	<!-- 系统管路员查询的选题申报数（主任界面） -->
	<select id="totalDirectorView" resultType="Integer">
		SELECT count(*)
		FROM topic a
		LEFT JOIN writer_user b ON a.user_id = b.id
		WHERE a.is_director_handling = TRUE
		AND a.is_editor_handling = FALSE
		<if test="bookName != null and bookName !=''">
			AND a.bookname like concat('%',#{bookName},'%')
		</if>
		<if test="submitTime != null">
			AND a.submit_time = #{submitTime}
		</if>
		ORDER BY a.submit_time
	</select>

	<!-- 系统管理员查询选题申报（编辑界面） -->
	<select id="listEditorView" resultType="TopicEditorVO">
		SELECT a.*,b.realname
		FROM topic a
		LEFT JOIN writer_user b ON a.user_id
		= b.id
		WHERE a.is_editor_handling = TRUE
		AND a.is_rejected_by_editor =
		FALSE
		<if test="bookName != null and bookName !=''">
			AND a.bookname like concat('%',#{bookName},'%')
		</if>
		<if test="submitTime != null">
			AND a.submit_time = #{submitTime}
		</if>
		ORDER BY a.submit_time
		LIMIT
		#{start},#{pageSize}
	</select>

	<!-- 系统管理员查询选题申报数（编辑界面） -->
	<select id="totalEditorView" resultType="Integer">
		SELECT count(*)
		FROM topic a
		LEFT JOIN writer_user b ON a.user_id = b.id
		WHERE a.is_editor_handling = TRUE
		AND a.is_rejected_by_editor = FALSE
		<if test="bookName != null and bookName !=''">
			AND a.bookname like concat('%',#{bookName},'%')
		</if>
		<if test="submitTime != null">
			AND a.submit_time = #{submitTime}
		</if>
		ORDER BY a.submit_time
	</select>

	<select id="getMaxTopicVn" resultType="java.lang.String">
		select max(vn) from topic
	</select>

	<!-- 动态修改选题申报 -->
	<update id="updateByVn" parameterType="Topic">
		UPDATE topic
		<set>
			<if test="userId != null">
				user_id = #{userId},
			</if>
			<if test="bookname != null and bookname !='' ">
				bookname = #{bookname},
			</if>
			<if test="reader != null ">
				reader = #{reader},
			</if>
			<if test="deadline != null ">
				deadline = #{deadline},
			</if>
			<if test="source != null">
				source = #{source},
			</if>
			<if test="wordNumber != null">
				word_number =#{wordNumber},
			</if>
			<if test="pictureNumber != null">
				picture_number =#{pictureNumber},
			</if>
			<if test="subject != null and subject !='' ">
				subject = #{subject},
			</if>
			<if test="rank != null">
				rank = #{rank},
			</if>
			<if test="type != null">
				type = #{type},
			</if>
			<if test="bankAccountId != null">
				bank_account_id = #{bankAccountId},
			</if>
			<if test="purchase != null">
				purchase = #{purchase},
			</if>
			<if test="sponsorship != null">
				sponsorship = #{sponsorship},
			</if>
			<if test="isTranslation != null">
				is_translation = #{isTranslation},
			</if>
			<if test="originalBookname != null and originalBookname !='' ">
				original_bookname = #{originalBookname},
			</if>
			<if test="originalAuthor != null and originalAuthor !='' ">
				original_author = #{originalAuthor},
			</if>
			<if test="nation != null and nation !='' ">
				nation = #{nation},
			</if>
			<if test="edition != null and edition !='' ">
				edition = #{edition},
			</if>
			<if test="authProgress != null">
				auth_progress = #{authProgress},
			</if>
			<if test="authFeedback != null and authFeedback !='' ">
				auth_feedback = #{authFeedback},
			</if>
			<if test="authDate != null">
				auth_date = #{authDate},
			</if>
			<if test="isOptsHandling != null">
				is_opts_handling = #{isOptsHandling},
			</if>
			<if test="optsRoleId != null">
				opts_role_id = #{optsRoleId},
			</if>
			<if test="isRejectedByDirector != null">
				is_rejected_by_director = #{isRejectedByDirector},
			</if>
			<if test="reasonDirector != null and reasonDirector !='' ">
				reason_director = #{reasonDirector},
			</if>
			<if test="isDirectorHandling != null">
				is_director_handling = #{isDirectorHandling},
			</if>
			<if test="departmentId != null">
				department_id = #{departmentId},
			</if>
			<if test="isRejectedByEditor != null">
				is_rejected_by_editor = #{isRejectedByEditor},
			</if>
			<if test="reasonEditor != null and reasonEditor !='' ">
				reason_editor = #{reasonEditor},
			</if>
			<if test="isEditorHandling != null">
				is_editor_handling = #{isEditorHandling},
			</if>
			<if test="editorId != null">
				editor_id = #{editorId},
			</if>
			<if test="isAccepted != null">
				is_accepted = #{isAccepted},
			</if>
			<if test="isStaging != null">
				is_staging = #{isStaging},
			</if>
			<if test="isDeleted != null">
				is_deleted = #{isDeleted},
			</if>
			<if test="note != null and note !='' ">
				note = #{note},
			</if>
			<if test="gmtCreate != null">
				gmt_create = #{gmtCreate},
			</if>
			<if test="gmtUpdate != null">
				gmt_update = #{gmtUpdate},
			</if>
			<if test="tn != null and tn !='' ">
				tn = #{tn},
			</if>
			<if test="submitTime != null">
				submit_time = #{submitTime},
			</if>
		</set>
		WHERE vn = #{vn};
	</update>
</mapper>